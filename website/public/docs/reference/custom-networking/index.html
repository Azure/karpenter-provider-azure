<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.145.0">



<title>Custom Networking | Karpenter for Azure</title>
<meta name="description" content="Configure Karpenter with custom VNet and subnet configurations
">

<meta property="og:url" content="//localhost:1313/docs/reference/custom-networking/">
  <meta property="og:site_name" content="Karpenter for Azure">
  <meta property="og:title" content="Custom Networking">
  <meta property="og:description" content="Configure Karpenter with custom VNet and subnet configurations">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
    <meta property="og:image" content="//localhost:1313/banner.png">


  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="//localhost:1313/banner.png">
  <meta name="twitter:title" content="Custom Networking">
  <meta name="twitter:description" content="Configure Karpenter with custom VNet and subnet configurations">






<link href="/scss/main.css" rel="stylesheet">


  </head>
  <body class="td-page">
    <header>
      <nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 500 443" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><path d="M237.704918.0C314.662629.0 377.04918 62.3865513 377.04918 139.344262L377.049 336.352 442.622951 336.351852C474.31142 336.351852 5e2 362.040432 5e2 393.728901V443h-7.546066c-18.225271.0-33.094961-14.592764-33.437541-32.814815V401.960534L459.013099 401.553891C458.795948 388.160675 447.871194 377.37037 434.42623 377.37037H106.557377c-58.8500143.0-106.557377-47.707362-106.557377-106.557377L-100611761e-22 139.344262c0-76.9577107 62.3865513-139.344262 139.344262-139.344262zm-8.196721 41.0185185H147.540984L145.778863 41.0327942C87.7415928 41.97378 40.9836066 89.3143814 40.9836066 147.575896V270.778081L40.9923916 271.862464C41.5714598 307.577706 70.7041376 336.351852 106.557377 336.351852H270.491803c36.215394.0 65.573771-29.358377 65.573771-65.573771V147.575896L336.051298 145.813774C335.110312 87.7765047 287.769711 41.0185185 229.508197 41.0185185zM147.868852 106.648148C157.213115 106.648148 164.590164 114.277593 164.590164 123.875926v49.960555l56.803279-58.574444C228.770492 108.370926 238.852459 107.878704 245.983607 114.523704V114.769815C252.868852 121.168704 252.377049 131.751481 244.754098 138.642593l-42.04918 43.315555 48.934426 69.895556C257.540984 260.467593 255.819672 271.296481 247.95082 276.464815 239.344262 281.387037 229.508197 278.679815 223.606557 270.065926l-44.016393-64.481111-15 15.751111v40.362222c0 9.84444500000001-7.377049 17.227778-16.721312 17.227778C138.52459 278.925926 131.147541 271.542593 131.147541 261.698148V123.875926c0-9.59833300000001 7.377049-17.227778 16.721311-17.227778z" id="white_square_logo" fill="#fff"/></g></svg></span><span class="navbar-brand__name">Karpenter for Azure</span></a>
  <div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
    <ul class="navbar-nav mt-2 mt-lg-0">
      <li class="nav-item mr-4 mb-2 mb-lg-0">
        <a class="nav-link" href="/docs"><i class='fas fa-book'></i><span>Docs</span></a>
      </li>
      <li class="nav-item mr-4 mb-2 mb-lg-0">
        <a class="nav-link" href="https://github.com/Azure/karpenter-provider-azure" target="_blank"><i class='fab fa-github'></i><span>GitHub</span></a>
      </li>
      <li class="nav-item dropdown mr-4 d-none d-lg-block">
        


	




<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	v1.5 
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink" id="navbarVersionSelector">
	
	<a class="dropdown-item" href='/v1.5.5//reference/custom-networking/' data-docs-version="v1.5.5">
		v1.5.5  (latest) 
	</a>
	
</div>
</li>
      </ul>
  </div>
  <div class="navbar-nav d-none d-lg-block">
    
  </div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            
<div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-section-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="collapse td-sidebar-nav foldable-nav" id="td-section-nav">
    <ul class="td-sidebar-nav__section pr-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docs-li">
  <a href="/docs/" title="Documentation" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-docs"><span class="">Docs</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docsgetting-started-li">
  <input type="checkbox" id="m-docsgetting-started-check"/>
  <label for="m-docsgetting-started-check"><a href="/docs/getting-started/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-docsgetting-started"><span class="">Getting Started</span></a></label>
  
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsgetting-startedquickstart-li">
  <input type="checkbox" id="m-docsgetting-startedquickstart-check"/>
  <label for="m-docsgetting-startedquickstart-check"><a href="/docs/getting-started/quickstart/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsgetting-startedquickstart"><span class="">Quickstart</span></a></label>
  
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docsconcepts-li">
  <input type="checkbox" id="m-docsconcepts-check"/>
  <label for="m-docsconcepts-check"><a href="/docs/concepts/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-docsconcepts"><span class="">Concepts</span></a></label>
  
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsconceptsnodepools-li">
  <input type="checkbox" id="m-docsconceptsnodepools-check"/>
  <label for="m-docsconceptsnodepools-check"><a href="/docs/concepts/nodepools/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsconceptsnodepools"><span class="">NodePools</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsconceptsnodeclasses-li">
  <input type="checkbox" id="m-docsconceptsnodeclasses-check"/>
  <label for="m-docsconceptsnodeclasses-check"><a href="/docs/concepts/nodeclasses/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsconceptsnodeclasses"><span class="">NodeClasses</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsconceptsscheduling-li">
  <input type="checkbox" id="m-docsconceptsscheduling-check"/>
  <label for="m-docsconceptsscheduling-check"><a href="/docs/concepts/scheduling/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsconceptsscheduling"><span class="">Scheduling</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsconceptsdisruption-li">
  <input type="checkbox" id="m-docsconceptsdisruption-check"/>
  <label for="m-docsconceptsdisruption-check"><a href="/docs/concepts/disruption/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsconceptsdisruption"><span class="">Disruption</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsconceptsnap-vs-self-hosted-li">
  <input type="checkbox" id="m-docsconceptsnap-vs-self-hosted-check"/>
  <label for="m-docsconceptsnap-vs-self-hosted-check"><a href="/docs/concepts/nap-vs-self-hosted/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsconceptsnap-vs-self-hosted"><span class="">Deployment Modes</span></a></label>
  
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docsreference-li">
  <input type="checkbox" id="m-docsreference-check" checked/>
  <label for="m-docsreference-check"><a href="/docs/reference/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-docsreference"><span class="">Reference</span></a></label>
  
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsreferencesettings-li">
  <input type="checkbox" id="m-docsreferencesettings-check"/>
  <label for="m-docsreferencesettings-check"><a href="/docs/reference/settings/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsreferencesettings"><span class="">Settings</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-docsreferencecustom-networking-li">
  <input type="checkbox" id="m-docsreferencecustom-networking-check" checked/>
  <label for="m-docsreferencecustom-networking-check"><a href="/docs/reference/custom-networking/" class="align-left pl-0  active td-sidebar-link td-sidebar-link__page" id="m-docsreferencecustom-networking"><span class="td-sidebar-nav-active-item">Custom Networking</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsreferenceinstance-types-li">
  <input type="checkbox" id="m-docsreferenceinstance-types-check"/>
  <label for="m-docsreferenceinstance-types-check"><a href="/docs/reference/instance-types/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsreferenceinstance-types"><span class="">Instance Types</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsreferencemetrics-li">
  <input type="checkbox" id="m-docsreferencemetrics-check"/>
  <label for="m-docsreferencemetrics-check"><a href="/docs/reference/metrics/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsreferencemetrics"><span class="">Metrics</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsreferencenodepool-examples-li">
  <input type="checkbox" id="m-docsreferencenodepool-examples-check"/>
  <label for="m-docsreferencenodepool-examples-check"><a href="/docs/reference/nodepool-examples/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsreferencenodepool-examples"><span class="">NodePool Examples</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsreferencenodepools-li">
  <input type="checkbox" id="m-docsreferencenodepools-check"/>
  <label for="m-docsreferencenodepools-check"><a href="/docs/reference/nodepools/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsreferencenodepools"><span class=""></span></a></label>
  
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsfaq-li">
  <input type="checkbox" id="m-docsfaq-check"/>
  <label for="m-docsfaq-check"><a href="/docs/faq/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsfaq"><span class="">FAQ</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docstroubleshooting-li">
  <input type="checkbox" id="m-docstroubleshooting-check"/>
  <label for="m-docstroubleshooting-check"><a href="/docs/troubleshooting/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docstroubleshooting"><span class="">Troubleshooting</span></a></label>
  
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
<a href="https://github.com/Azure/karpenter-provider-azure/tree/main/website/content/en/docs/reference/custom-networking.md" class="td-page-meta--view" target="_blank" rel="noopener"><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
  <a href="https://github.com/Azure/karpenter-provider-azure/edit/main/website/content/en/docs/reference/custom-networking.md" class="td-page-meta--edit" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
  <a href="https://github.com/Azure/karpenter-provider-azure/new/main/website/content/en/docs/reference/custom-networking.md?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" class="td-page-meta--child" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
  <a href="https://github.com/Azure/karpenter-provider-azure/issues/new?title=Custom%20Networking" class="td-page-meta--issue" target="_blank" rel="noopener"><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a>
  
</div>

            <div class="td-toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#cluster-setup-with-custom-vnet-and-subnets">Cluster Setup with Custom VNet and Subnets</a>
      <ul>
        <li><a href="#creating-vnet-and-subnets">Creating VNet and Subnets</a></li>
        <li><a href="#creating-aks-cluster-with-custom-vnet">Creating AKS Cluster with Custom VNet</a></li>
        <li><a href="#karpenter-installation">Karpenter Installation</a></li>
      </ul>
    </li>
    <li><a href="#prerequisites">Prerequisites</a></li>
    <li><a href="#vnet-subnet-configuration">VNet Subnet Configuration</a></li>
    <li><a href="#rbac-configuration">RBAC Configuration</a>
      <ul>
        <li><a href="#approach-a-broad-vnet-permissions">Approach A: Broad VNet Permissions</a></li>
        <li><a href="#approach-b-scoped-subnet-permissions">Approach B: Scoped Subnet Permissions</a></li>
      </ul>
    </li>
    <li><a href="#example-aksnodeclass-configurations">Example AKSNodeClass Configurations</a>
      <ul>
        <li><a href="#single-custom-subnet">Single Custom Subnet</a></li>
        <li><a href="#multiple-nodeclasses-for-different-subnets">Multiple NodeClasses for Different Subnets</a></li>
      </ul>
    </li>
    <li><a href="#nodepool-configuration">NodePool Configuration</a></li>
    <li><a href="#subnet-drift-behavior">Subnet Drift Behavior</a>
      <ul>
        <li><a href="#-unsupported-configuration-path">⚠️ Unsupported Configuration Path</a></li>
        <li><a href="#supported-use-case-fixing-invalid-subnet-ids">Supported Use Case: Fixing Invalid Subnet IDs</a></li>
        <li><a href="#unsupported-use-case-subnet-migration">Unsupported Use Case: Subnet Migration</a></li>
        <li><a href="#what-happens-when-you-modify-vnetsubnetid">What Happens When You Modify vnetSubnetID</a></li>
        <li><a href="#recommended-approach-for-subnet-changes">Recommended Approach for Subnet Changes</a></li>
      </ul>
    </li>
    <li><a href="#understanding-aks-cluster-cidr-ranges">Understanding AKS Cluster CIDR Ranges</a>
      <ul>
        <li><a href="#key-cidr-considerations">Key CIDR Considerations</a></li>
        <li><a href="#identifying-your-cluster-cidrs">Identifying Your Cluster CIDRs</a></li>
        <li><a href="#validation-differences">Validation Differences</a></li>
        <li><a href="#customer-responsibilities">Customer Responsibilities</a></li>
        <li><a href="#common-cidr-conflicts">Common CIDR Conflicts</a></li>
        <li><a href="#network-planning-best-practices">Network Planning Best Practices</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
    
            

	

          </aside>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="td-breadcrumbs">
  <ol class="breadcrumb">
  <li class="breadcrumb-item">
    <a href="//localhost:1313/docs/">Docs</a>
  </li>
  <li class="breadcrumb-item">
    <a href="//localhost:1313/docs/reference/">Reference</a>
  </li>
  <li class="breadcrumb-item active" aria-current="page">
    <a href="//localhost:1313/docs/reference/custom-networking/" aria-disabled="true" class="btn-link disabled">Custom Networking</a>
  </li>
  </ol>
</nav>
            
<div class="td-content">
	<h1>Custom Networking</h1>
	<div class="lead">Configure Karpenter with custom VNet and subnet configurations</div>
	<header class="article-meta">
		

  

		
	</header>    
	<h2 id="cluster-setup-with-custom-vnet-and-subnets">Cluster Setup with Custom VNet and Subnets</h2>
<p>Karpenter supports custom networking configurations that allow you to specify different subnets for your nodes. This is particularly useful when you need to place nodes in specific subnets for compliance, security, or network segmentation requirements.</p>
<h3 id="creating-vnet-and-subnets">Creating VNet and Subnets</h3>
<p>First, create a VNet with two subnets for your AKS cluster:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Set variables</span>
</span></span><span style="display:flex;"><span><span style="color:#000">RESOURCE_GROUP</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;my-aks-rg&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">LOCATION</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;eastus&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">VNET_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;my-aks-vnet&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">CLUSTER_SUBNET</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;cluster-subnet&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">CUSTOM_SUBNET</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;custom-subnet&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">CLUSTER_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;my-aks-cluster&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Create resource group</span>
</span></span><span style="display:flex;"><span>az group create --name <span style="color:#000">$RESOURCE_GROUP</span> --location <span style="color:#000">$LOCATION</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Create VNet with address space</span>
</span></span><span style="display:flex;"><span>az network vnet create <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --resource-group <span style="color:#000">$RESOURCE_GROUP</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --name <span style="color:#000">$VNET_NAME</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --address-prefixes 10.0.0.0/16
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Create cluster subnet for main AKS nodes</span>
</span></span><span style="display:flex;"><span>az network vnet subnet create <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --resource-group <span style="color:#000">$RESOURCE_GROUP</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --vnet-name <span style="color:#000">$VNET_NAME</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --name <span style="color:#000">$CLUSTER_SUBNET</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --address-prefixes 10.0.1.0/24
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Create custom subnet for Karpenter nodes</span>
</span></span><span style="display:flex;"><span>az network vnet subnet create <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --resource-group <span style="color:#000">$RESOURCE_GROUP</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --vnet-name <span style="color:#000">$VNET_NAME</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --name <span style="color:#000">$CUSTOM_SUBNET</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --address-prefixes 10.0.2.0/24
</span></span></code></pre></div><h3 id="creating-aks-cluster-with-custom-vnet">Creating AKS Cluster with Custom VNet</h3>
<p>Create the AKS cluster using the cluster subnet:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Get subnet ID for cluster creation</span>
</span></span><span style="display:flex;"><span><span style="color:#000">CLUSTER_SUBNET_ID</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>az network vnet subnet show <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --resource-group <span style="color:#000">$RESOURCE_GROUP</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --vnet-name <span style="color:#000">$VNET_NAME</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --name <span style="color:#000">$CLUSTER_SUBNET</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --query id -o tsv<span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Create AKS cluster with custom VNet and Karpenter enabled</span>
</span></span><span style="display:flex;"><span>az aks create <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --resource-group <span style="color:#000">$RESOURCE_GROUP</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --name <span style="color:#000">$CLUSTER_NAME</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --node-count <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --vnet-subnet-id <span style="color:#000">$CLUSTER_SUBNET_ID</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --network-plugin azure <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --enable-managed-identity <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --node-provisioning-mode Auto <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --generate-ssh-keys
</span></span></code></pre></div><h3 id="karpenter-installation">Karpenter Installation</h3>
<p>Karpenter is automatically installed when using <code>--node-provisioning-mode Auto</code> during cluster creation.</p>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>Azure CLI installed and authenticated</li>
<li>An AKS cluster with Karpenter installed (created above)</li>
<li>Custom subnets in your VNet (created above)</li>
<li>Appropriate RBAC permissions for subnet access</li>
</ul>
<h2 id="vnet-subnet-configuration">VNet Subnet Configuration</h2>
<p>You can configure custom subnet IDs in your AKSNodeClass using the <code>vnetSubnetID</code> field:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">karpenter.azure.com/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AKSNodeClass</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">custom-networking</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vnetSubnetID</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/my-aks-rg/providers/Microsoft.Network/virtualNetworks/my-aks-vnet/subnets/custom-subnet&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="rbac-configuration">RBAC Configuration</h2>
<p>When using custom subnet configurations, Karpenter needs appropriate permissions to read subnet information and join nodes to the specified subnets. There are two recommended approaches for configuring these permissions.</p>
<h3 id="approach-a-broad-vnet-permissions">Approach A: Broad VNet Permissions</h3>
<p>This approach grants the cluster identity permissions to read and join any subnet within the main VNet, as well as overall network contributor. Its very permissive, investigate the &ldquo;Network Contributor&rdquo; role before applying this to your production cluster.</p>
<h4 id="required-permissions">Required Permissions</h4>
<p>Assign the following roles to your cluster identity at the VNet scope:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Get your cluster&#39;s managed identity</span>
</span></span><span style="display:flex;"><span><span style="color:#000">CLUSTER_IDENTITY</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>az aks show --resource-group &lt;cluster-rg&gt; --name &lt;cluster-name&gt; --query identity.principalId -o tsv<span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Get your VNet resource ID</span>
</span></span><span style="display:flex;"><span><span style="color:#000">VNET_ID</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/subscriptions/&lt;subscription-id&gt;/resourceGroups/&lt;vnet-rg&gt;/providers/Microsoft.Network/virtualNetworks/&lt;vnet-name&gt;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Assign Network Contributor role for subnet read/join operations</span>
</span></span><span style="display:flex;"><span>az role assignment create <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --assignee <span style="color:#000">$CLUSTER_IDENTITY</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --role <span style="color:#4e9a06">&#34;Network Contributor&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --scope <span style="color:#000">$VNET_ID</span>
</span></span></code></pre></div><h4 id="benefits">Benefits</h4>
<ul>
<li>Simplified permission management</li>
<li>No need to update permissions when adding new subnets</li>
<li>Works well for single-tenant environments</li>
<li>In cases where a subscription has reached the maximium number of custom roles, this approach works</li>
</ul>
<h4 id="example-script">Example Script</h4>
<p>For a complete example of setting up custom networking with Approach A permissions, see this <a href="https://gist.github.com/Bryce-Soghigian/a4259d6224db0c55081718caa7b37268">sample setup script</a>.</p>
<h4 id="considerations">Considerations</h4>
<ul>
<li>Broader permissions than strictly necessary</li>
<li>May not meet strict security requirements</li>
</ul>
<h3 id="approach-b-scoped-subnet-permissions">Approach B: Scoped Subnet Permissions</h3>
<p>This approach grants permissions on a per-subnet basis, providing more granular control over which subnets the cluster can access.</p>
<h4 id="required-permissions-1">Required Permissions</h4>
<p>For each subnet you want to use with Karpenter, assign the following specific permissions:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Get your cluster&#39;s managed identity</span>
</span></span><span style="display:flex;"><span><span style="color:#000">CLUSTER_IDENTITY</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>az aks show --resource-group &lt;cluster-rg&gt; --name &lt;cluster-name&gt; --query identity.principalId -o tsv<span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># For each subnet, assign specific subnet permissions</span>
</span></span><span style="display:flex;"><span><span style="color:#000">SUBNET_ID</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/subscriptions/&lt;subscription-id&gt;/resourceGroups/&lt;vnet-rg&gt;/providers/Microsoft.Network/virtualNetworks/&lt;vnet-name&gt;/subnets/&lt;subnet-name&gt;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Create custom role definition for subnet access</span>
</span></span><span style="display:flex;"><span>cat &gt; subnet-access-role.json <span style="color:#4e9a06">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">{
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;Name&#34;: &#34;Karpenter Subnet Access&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;IsCustom&#34;: true,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;Description&#34;: &#34;Allows reading subnet information and joining VMs to subnets&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;Actions&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;Microsoft.Network/virtualNetworks/subnets/read&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;Microsoft.Network/virtualNetworks/subnets/join/action&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  ],
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;NotActions&#34;: [],
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;DataActions&#34;: [],
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;NotDataActions&#34;: [],
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;AssignableScopes&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;/subscriptions/&lt;subscription-id&gt;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  ]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">}
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Create the custom role (only needed once per subscription)</span>
</span></span><span style="display:flex;"><span>az role definition create --role-definition subnet-access-role.json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Assign the custom role to each subnet</span>
</span></span><span style="display:flex;"><span>az role assignment create <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --assignee <span style="color:#000">$CLUSTER_IDENTITY</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --role <span style="color:#4e9a06">&#34;Karpenter Subnet Access&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --scope <span style="color:#000">$SUBNET_ID</span>
</span></span></code></pre></div><h4 id="alternative-using-built-in-roles">Alternative: Using Built-in Roles</h4>
<p>If you prefer using built-in roles, you can assign these specific permissions individually:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Assign Network Reader role for subnet read access</span>
</span></span><span style="display:flex;"><span>az role assignment create <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --assignee <span style="color:#000">$CLUSTER_IDENTITY</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --role <span style="color:#4e9a06">&#34;Network Contributor&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --scope <span style="color:#000">$SUBNET_ID</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --condition <span style="color:#4e9a06">&#34;((!(ActionMatches{&#39;Microsoft.Network/virtualNetworks/subnets/write&#39;})) AND (!(ActionMatches{&#39;Microsoft.Network/virtualNetworks/subnets/delete&#39;})))&#34;</span>
</span></span></code></pre></div><blockquote>
<p><strong>Note</strong>: The condition parameter limits the Network Contributor role to only read and join operations on subnets, excluding write and delete permissions.</p></blockquote>
<h4 id="benefits-1">Benefits</h4>
<ul>
<li>Principle of least privilege</li>
<li>Granular access control</li>
<li>Better compliance with security policies</li>
</ul>
<h4 id="example-script-1">Example Script</h4>
<p>For a complete example of setting up custom networking with Approach B permissions, see this <a href="https://gist.github.com/Bryce-Soghigian/fc3de3a796b20dbed8fe5d2ca0c85dd4">scoped subnet permissions script</a>.</p>
<h4 id="considerations-1">Considerations</h4>
<ul>
<li>More complex permission management</li>
<li>Need to update permissions for each new subnet</li>
<li>Requires coordination between network and cluster administrators</li>
</ul>
<h2 id="example-aksnodeclass-configurations">Example AKSNodeClass Configurations</h2>
<h3 id="single-custom-subnet">Single Custom Subnet</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">karpenter.azure.com/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AKSNodeClass</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dedicated-workload</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vnetSubnetID</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/my-aks-rg/providers/Microsoft.Network/virtualNetworks/my-aks-vnet/subnets/custom-subnet&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="multiple-nodeclasses-for-different-subnets">Multiple NodeClasses for Different Subnets</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">karpenter.azure.com/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AKSNodeClass</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">frontend-nodes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vnetSubnetID</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/my-aks-rg/providers/Microsoft.Network/virtualNetworks/my-aks-vnet/subnets/custom-subnet&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">karpenter.azure.com/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AKSNodeClass</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">backend-nodes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">vnetSubnetID</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx/resourceGroups/my-aks-rg/providers/Microsoft.Network/virtualNetworks/my-aks-vnet/subnets/custom-subnet2&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="nodepool-configuration">NodePool Configuration</h2>
<p>Create NodePools that reference your custom AKSNodeClass:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">karpenter.sh/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NodePool</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">custom-networking-pool</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">nodeClassRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">group</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">karpenter.azure.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AKSNodeClass</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">custom-networking</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">requirements</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes.io/arch</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">In</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;amd64&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">karpenter.sh/capacity-type</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">In</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;on-demand&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">limits</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">disruption</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">consolidationPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">WhenEmpty</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">consolidateAfter</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">30s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="subnet-drift-behavior">Subnet Drift Behavior</h2>
<p>Karpenter monitors subnet configuration changes and will detect drift when the <code>vnetSubnetID</code> in an AKSNodeClass is modified. Understanding this behavior is critical when managing custom networking configurations.</p>
<h3 id="-unsupported-configuration-path">⚠️ Unsupported Configuration Path</h3>
<p><strong>Modifying <code>vnetSubnetID</code> from one valid subnet to another valid subnet is NOT a supported operation.</strong> This field is mutable solely to provide an escape hatch for correcting invalid or malformed subnet IDs during initial configuration.</p>
<h3 id="supported-use-case-fixing-invalid-subnet-ids">Supported Use Case: Fixing Invalid Subnet IDs</h3>
<p>The <code>vnetSubnetID</code> field can be modified only in these scenarios:</p>
<ul>
<li>Correcting a malformed subnet ID that prevents node provisioning</li>
<li>Fixing an invalid subnet reference that causes configuration errors</li>
<li>Updating a subnet ID that points to a non-existent or inaccessible subnet</li>
</ul>
<h3 id="unsupported-use-case-subnet-migration">Unsupported Use Case: Subnet Migration</h3>
<p><strong>DO NOT</strong> use this field to migrate nodes between valid subnets. This includes:</p>
<ul>
<li>Moving nodes from one subnet to another for network reorganization</li>
<li>Changing subnet configurations for capacity or performance reasons</li>
<li>Migrating between subnets as part of infrastructure changes</li>
</ul>
<p><strong>Support Policy</strong>: Microsoft will not provide support for issues arising from subnet-to-subnet migrations via <code>vnetSubnetID</code> modifications. Support tickets related to such operations will be declined.</p>
<h3 id="what-happens-when-you-modify-vnetsubnetid">What Happens When You Modify vnetSubnetID</h3>
<p>If you modify the field (even for unsupported use cases):</p>
<ol>
<li><strong>Drift Detection</strong>: Karpenter detects the subnet mismatch and marks nodes for replacement</li>
<li><strong>Node Disruption</strong>: Existing nodes will be cordoned, drained, and terminated</li>
<li><strong>Potential Issues</strong>: Network connectivity problems, workload disruptions, and unpredictable behavior</li>
<li><strong>No Support</strong>: Microsoft support will not assist with issues from this configuration path</li>
</ol>
<h3 id="recommended-approach-for-subnet-changes">Recommended Approach for Subnet Changes</h3>
<p>For legitimate subnet migration needs:</p>
<ol>
<li>Create a new AKSNodeClass with the desired subnet</li>
<li>Create a new NodePool referencing the new AKSNodeClass</li>
<li>Gradually migrate workloads to the new NodePool</li>
<li>Delete the old NodePool and AKSNodeClass when migration is complete</li>
</ol>
<p>This approach provides controlled migration with proper testing and rollback capabilities.</p>
<h2 id="understanding-aks-cluster-cidr-ranges">Understanding AKS Cluster CIDR Ranges</h2>
<p>When configuring custom networking with <code>vnetSubnetID</code>, customers are responsible for understanding and managing their cluster&rsquo;s CIDR ranges to avoid network conflicts. Unlike traditional AKS NodePools created through ARM templates, Karpenter applies custom resource definitions (CRDs) that provision nodes instantly without the extended validation that ARM provides.</p>
<h3 id="key-cidr-considerations">Key CIDR Considerations</h3>
<p><strong>Cluster and Service CIDRs</strong>: Your AKS cluster is configured with specific CIDR ranges for:</p>
<ul>
<li><strong>Cluster CIDR</strong> (<code>--pod-cidr</code>): IP range for pod networking</li>
<li><strong>Service CIDR</strong> (<code>--service-cidr</code>): IP range for Kubernetes services</li>
</ul>
<p><strong>Custom Subnet Requirements</strong>: When using <code>vnetSubnetID</code>, ensure your custom subnets:</p>
<ul>
<li>Do not overlap with cluster, service, or use any of the reserved addresses</li>
<li>Have sufficient IP addresses for expected node and pod scaling</li>
</ul>
<h3 id="identifying-your-cluster-cidrs">Identifying Your Cluster CIDRs</h3>
<p>Use these commands to identify your cluster&rsquo;s network configuration:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Get cluster network details</span>
</span></span><span style="display:flex;"><span>az aks show --resource-group &lt;rg-name&gt; --name &lt;cluster-name&gt; <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --query <span style="color:#4e9a06">&#34;{podCidr:networkProfile.podCidr,serviceCidr:networkProfile.serviceCidr,dockerBridgeCidr:networkProfile.dockerBridgeCidr}&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --output table
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Get cluster subnet information</span>
</span></span><span style="display:flex;"><span>az aks show --resource-group &lt;rg-name&gt; --name &lt;cluster-name&gt; <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --query <span style="color:#4e9a06">&#34;agentPoolProfiles[0].vnetSubnetId&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --output tsv
</span></span></code></pre></div><h3 id="validation-differences">Validation Differences</h3>
<p><strong>ARM Template Validation</strong>: Traditional AKS NodePools undergo comprehensive validation:</p>
<ul>
<li>CIDR conflict detection</li>
<li>Subnet capacity verification</li>
<li>Network policy validation</li>
<li>Extended provisioning time with validation checks</li>
</ul>
<p><strong>Karpenter CRD Application</strong>: Custom resources apply immediately:</p>
<ul>
<li><strong>⚠️ No automatic CIDR conflict detection</strong></li>
<li><strong>⚠️ No subnet capacity pre-validation</strong></li>
<li><strong>⚠️ Instant application without extended validation</strong></li>
<li>Faster provisioning but requires pre-planning</li>
</ul>
<h3 id="customer-responsibilities">Customer Responsibilities</h3>
<p>When configuring <code>vnetSubnetID</code>, you must:</p>
<ol>
<li><strong>Verify CIDR Compatibility</strong>: Ensure custom subnets don&rsquo;t conflict with existing cluster CIDRs</li>
<li><strong>Plan IP Capacity</strong>: Calculate required IP addresses for expected scaling</li>
<li><strong>Validate Connectivity</strong>: Test network routes and security group rules</li>
<li><strong>Monitor Usage</strong>: Track subnet utilization and plan for growth</li>
<li><strong>Document Configuration</strong>: Maintain records of network design decisions</li>
</ol>
<h3 id="common-cidr-conflicts">Common CIDR Conflicts</h3>
<p>Be aware of these potential conflicts:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Example conflict scenarios:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Cluster Pod CIDR: 10.244.0.0/16  </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Custom Subnet:   10.244.1.0/24  ❌ CONFLICT</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Service CIDR:    10.0.0.0/16</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Custom Subnet:   10.0.10.0/24   ❌ CONFLICT</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Safe configuration:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Cluster Pod CIDR: 10.244.0.0/16</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Service CIDR:     10.0.0.0/16  </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Custom Subnet:    10.1.0.0/24   ✅ NO CONFLICT</span>
</span></span></code></pre></div><h3 id="network-planning-best-practices">Network Planning Best Practices</h3>
<ul>
<li><strong>Document all CIDR allocations</strong> before implementing custom networking</li>
<li><strong>Use non-overlapping private IP ranges</strong> (RFC 1918)</li>
<li><strong>Plan for future expansion</strong> with appropriately sized subnets</li>
<li><strong>Test configurations</strong> in non-production environments first</li>
<li><strong>Monitor network utilization</strong> and plan capacity accordingly</li>
</ul>

	
	
	
</div>


          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <p class="mx-auto col-sm-3 text-center text-light">
        Built with ❤️ at <a class="text-light" href="https://aws.amazon.com/">AWS</a>
      </p>
    </div>
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
          
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
          
            
  <ul class="list-inline mb-0">
    
      <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
        <a class="text-white" target="_blank" rel="noopener" href="https://github.com/Azure/karpenter-provider-azure" aria-label="GitHub">
          <i class="fab fa-github"></i>
        </a>
      </li>
    
      <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
        <a class="text-white" target="_blank" rel="noopener" href="https://slack.k8s.io/" aria-label="Slack">
          <i class="fab fa-slack"></i>
        </a>
      </li>
    
  </ul>

          
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2025 Microsoft Corporation or its affiliates. All Rights Reserved</small>
        
        
      </div>
    </div>
  </div>
</footer>


    </div>
    
  <script src="/js/main.js"></script>
<script src='/js/prism.js'></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>