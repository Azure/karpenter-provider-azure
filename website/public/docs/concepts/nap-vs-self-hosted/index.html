<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.145.0">



<title>NAP vs Self-Hosted | Karpenter for Azure</title>
<meta name="description" content="Understanding Node Auto Provisioning (NAP) vs Self-hosted deployment options
">

<meta property="og:url" content="//localhost:1313/docs/concepts/nap-vs-self-hosted/">
  <meta property="og:site_name" content="Karpenter for Azure">
  <meta property="og:title" content="NAP vs Self-Hosted">
  <meta property="og:description" content="Understanding Node Auto Provisioning (NAP) vs Self-hosted deployment options">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
    <meta property="og:image" content="//localhost:1313/banner.png">


  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="//localhost:1313/banner.png">
  <meta name="twitter:title" content="NAP vs Self-Hosted">
  <meta name="twitter:description" content="Understanding Node Auto Provisioning (NAP) vs Self-hosted deployment options">






<link href="/scss/main.css" rel="stylesheet">


  </head>
  <body class="td-page">
    <header>
      <nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 500 443" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><path d="M237.704918.0C314.662629.0 377.04918 62.3865513 377.04918 139.344262L377.049 336.352 442.622951 336.351852C474.31142 336.351852 5e2 362.040432 5e2 393.728901V443h-7.546066c-18.225271.0-33.094961-14.592764-33.437541-32.814815V401.960534L459.013099 401.553891C458.795948 388.160675 447.871194 377.37037 434.42623 377.37037H106.557377c-58.8500143.0-106.557377-47.707362-106.557377-106.557377L-100611761e-22 139.344262c0-76.9577107 62.3865513-139.344262 139.344262-139.344262zm-8.196721 41.0185185H147.540984L145.778863 41.0327942C87.7415928 41.97378 40.9836066 89.3143814 40.9836066 147.575896V270.778081L40.9923916 271.862464C41.5714598 307.577706 70.7041376 336.351852 106.557377 336.351852H270.491803c36.215394.0 65.573771-29.358377 65.573771-65.573771V147.575896L336.051298 145.813774C335.110312 87.7765047 287.769711 41.0185185 229.508197 41.0185185zM147.868852 106.648148C157.213115 106.648148 164.590164 114.277593 164.590164 123.875926v49.960555l56.803279-58.574444C228.770492 108.370926 238.852459 107.878704 245.983607 114.523704V114.769815C252.868852 121.168704 252.377049 131.751481 244.754098 138.642593l-42.04918 43.315555 48.934426 69.895556C257.540984 260.467593 255.819672 271.296481 247.95082 276.464815 239.344262 281.387037 229.508197 278.679815 223.606557 270.065926l-44.016393-64.481111-15 15.751111v40.362222c0 9.84444500000001-7.377049 17.227778-16.721312 17.227778C138.52459 278.925926 131.147541 271.542593 131.147541 261.698148V123.875926c0-9.59833300000001 7.377049-17.227778 16.721311-17.227778z" id="white_square_logo" fill="#fff"/></g></svg></span><span class="navbar-brand__name">Karpenter for Azure</span></a>
  <div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
    <ul class="navbar-nav mt-2 mt-lg-0">
      <li class="nav-item mr-4 mb-2 mb-lg-0">
        <a class="nav-link" href="/docs"><i class='fas fa-book'></i><span>Docs</span></a>
      </li>
      <li class="nav-item mr-4 mb-2 mb-lg-0">
        <a class="nav-link" href="https://github.com/Azure/karpenter-provider-azure" target="_blank"><i class='fab fa-github'></i><span>GitHub</span></a>
      </li>
      <li class="nav-item dropdown mr-4 d-none d-lg-block">
        


	




<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	v1.5.5  (latest) 
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink" id="navbarVersionSelector">
	
	<a class="dropdown-item" href='/v1.5.5//concepts/nap-vs-self-hosted/' data-docs-version="v1.5.5">
		v1.5.5  (latest) 
	</a>
	
</div>
</li>
      </ul>
  </div>
  <div class="navbar-nav d-none d-lg-block">
    
  </div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            
<div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-section-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="collapse td-sidebar-nav foldable-nav" id="td-section-nav">
    <ul class="td-sidebar-nav__section pr-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docs-li">
  <a href="/docs/" title="Documentation" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-docs"><span class="">Docs</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docsgetting-started-li">
  <input type="checkbox" id="m-docsgetting-started-check"/>
  <label for="m-docsgetting-started-check"><a href="/docs/getting-started/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-docsgetting-started"><span class="">Getting Started</span></a></label>
  
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsgetting-startedquickstart-li">
  <input type="checkbox" id="m-docsgetting-startedquickstart-check"/>
  <label for="m-docsgetting-startedquickstart-check"><a href="/docs/getting-started/quickstart/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsgetting-startedquickstart"><span class="">Quickstart</span></a></label>
  
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docsconcepts-li">
  <input type="checkbox" id="m-docsconcepts-check" checked/>
  <label for="m-docsconcepts-check"><a href="/docs/concepts/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-docsconcepts"><span class="">Concepts</span></a></label>
  
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsconceptsnodepools-li">
  <input type="checkbox" id="m-docsconceptsnodepools-check"/>
  <label for="m-docsconceptsnodepools-check"><a href="/docs/concepts/nodepools/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsconceptsnodepools"><span class="">NodePools</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsconceptsnodeclasses-li">
  <input type="checkbox" id="m-docsconceptsnodeclasses-check"/>
  <label for="m-docsconceptsnodeclasses-check"><a href="/docs/concepts/nodeclasses/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsconceptsnodeclasses"><span class="">NodeClasses</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsconceptsscheduling-li">
  <input type="checkbox" id="m-docsconceptsscheduling-check"/>
  <label for="m-docsconceptsscheduling-check"><a href="/docs/concepts/scheduling/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsconceptsscheduling"><span class="">Scheduling</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsconceptsdisruption-li">
  <input type="checkbox" id="m-docsconceptsdisruption-check"/>
  <label for="m-docsconceptsdisruption-check"><a href="/docs/concepts/disruption/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsconceptsdisruption"><span class="">Disruption</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-docsconceptsnap-vs-self-hosted-li">
  <input type="checkbox" id="m-docsconceptsnap-vs-self-hosted-check" checked/>
  <label for="m-docsconceptsnap-vs-self-hosted-check"><a href="/docs/concepts/nap-vs-self-hosted/" class="align-left pl-0  active td-sidebar-link td-sidebar-link__page" id="m-docsconceptsnap-vs-self-hosted"><span class="td-sidebar-nav-active-item">NAP vs Self-Hosted</span></a></label>
  
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docsreference-li">
  <input type="checkbox" id="m-docsreference-check"/>
  <label for="m-docsreference-check"><a href="/docs/reference/" class="align-left pl-0  td-sidebar-link td-sidebar-link__section" id="m-docsreference"><span class="">Reference</span></a></label>
  
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsreferencesettings-li">
  <input type="checkbox" id="m-docsreferencesettings-check"/>
  <label for="m-docsreferencesettings-check"><a href="/docs/reference/settings/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsreferencesettings"><span class="">Settings</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsreferencecustom-networking-li">
  <input type="checkbox" id="m-docsreferencecustom-networking-check"/>
  <label for="m-docsreferencecustom-networking-check"><a href="/docs/reference/custom-networking/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsreferencecustom-networking"><span class="">Custom Networking</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsreferenceinstance-types-li">
  <input type="checkbox" id="m-docsreferenceinstance-types-check"/>
  <label for="m-docsreferenceinstance-types-check"><a href="/docs/reference/instance-types/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsreferenceinstance-types"><span class="">Instance Types</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsreferencenodepool-examples-li">
  <input type="checkbox" id="m-docsreferencenodepool-examples-check"/>
  <label for="m-docsreferencenodepool-examples-check"><a href="/docs/reference/nodepool-examples/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsreferencenodepool-examples"><span class="">NodePool Examples</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsreferencenodepools-li">
  <input type="checkbox" id="m-docsreferencenodepools-check"/>
  <label for="m-docsreferencenodepools-check"><a href="/docs/reference/nodepools/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsreferencenodepools"><span class=""></span></a></label>
  
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsfaq-li">
  <input type="checkbox" id="m-docsfaq-check"/>
  <label for="m-docsfaq-check"><a href="/docs/faq/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docsfaq"><span class="">FAQ</span></a></label>
  
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docstroubleshooting-li">
  <input type="checkbox" id="m-docstroubleshooting-check"/>
  <label for="m-docstroubleshooting-check"><a href="/docs/troubleshooting/" class="align-left pl-0  td-sidebar-link td-sidebar-link__page" id="m-docstroubleshooting"><span class="">Troubleshooting</span></a></label>
  
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
<a href="https://github.com/Azure/karpenter-provider-azure/tree/main/website/content/en/docs/concepts/nap-vs-self-hosted.md" class="td-page-meta--view" target="_blank" rel="noopener"><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
  <a href="https://github.com/Azure/karpenter-provider-azure/edit/main/website/content/en/docs/concepts/nap-vs-self-hosted.md" class="td-page-meta--edit" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
  <a href="https://github.com/Azure/karpenter-provider-azure/new/main/website/content/en/docs/concepts/nap-vs-self-hosted.md?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" class="td-page-meta--child" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
  <a href="https://github.com/Azure/karpenter-provider-azure/issues/new?title=NAP%20vs%20Self-Hosted" class="td-page-meta--issue" target="_blank" rel="noopener"><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a>
  
</div>

            <div class="td-toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#node-auto-provisioning-nap-mode">Node Auto Provisioning (NAP) Mode</a>
      <ul>
        <li><a href="#what-is-nap">What is NAP?</a></li>
        <li><a href="#benefits-of-nap">Benefits of NAP</a></li>
        <li><a href="#when-to-use-nap">When to Use NAP</a></li>
        <li><a href="#nap--self-hosted-limitations">NAP + Self-Hosted Limitations</a></li>
        <li><a href="#using-nap">Using NAP</a></li>
      </ul>
    </li>
    <li><a href="#self-hosted-mode">Self-hosted Mode</a>
      <ul>
        <li><a href="#what-is-self-hosted-mode">What is Self-hosted Mode?</a></li>
        <li><a href="#self-hosted-limitations">Self-hosted Limitations</a></li>
        <li><a href="#self-hosted-architecture">Self-hosted Architecture</a></li>
        <li><a href="#installing-self-hosted-karpenter">Installing Self-hosted Karpenter</a></li>
        <li><a href="#features-available-in-nap-but-not-self-hosted">Features Available in NAP but Not Self-hosted</a></li>
      </ul>
    </li>
    <li><a href="#comparison-matrix">Comparison Matrix</a></li>
    <li><a href="#migration-between-modes">Migration Between Modes</a>
      <ul>
        <li><a href="#from-self-hosted-to-nap">From Self-hosted to NAP</a></li>
        <li><a href="#from-nap-to-self-hosted">From NAP to Self-hosted</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
    
            

	

          </aside>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="td-breadcrumbs">
  <ol class="breadcrumb">
  <li class="breadcrumb-item">
    <a href="//localhost:1313/docs/">Docs</a>
  </li>
  <li class="breadcrumb-item">
    <a href="//localhost:1313/docs/concepts/">Concepts</a>
  </li>
  <li class="breadcrumb-item active" aria-current="page">
    <a href="//localhost:1313/docs/concepts/nap-vs-self-hosted/" aria-disabled="true" class="btn-link disabled">NAP vs Self-Hosted</a>
  </li>
  </ol>
</nav>
            
<div class="td-content">
	<h1>NAP vs Self-Hosted</h1>
	<div class="lead">Understanding Node Auto Provisioning (NAP) vs Self-hosted deployment options</div>
	<header class="article-meta">
		

  

		
	</header>    
	<p>Karpenter for Azure offers two distinct deployment options to accommodate different user needs and preferences. Understanding these options will help you choose the right approach for your AKS cluster.</p>
<h2 id="overview">Overview</h2>
<p>Karpenter provider for AKS can be deployed in two modes:</p>
<ul>
<li><strong>Node Auto Provisioning (NAP)</strong>: A managed service where AKS runs Karpenter as an addon</li>
<li><strong>Self-hosted</strong>: A standalone deployment where you manage Karpenter directly in your cluster</li>
</ul>
<h2 id="node-auto-provisioning-nap-mode">Node Auto Provisioning (NAP) Mode</h2>
<h3 id="what-is-nap">What is NAP?</h3>
<p><a href="https://learn.microsoft.com/en-gb/azure/aks/node-autoprovision?tabs=azure-cli">Node Auto Provisioning (NAP)</a> is a managed service where AKS automatically deploys, configures, and manages Karpenter on your cluster. This is the <strong>recommended mode for most users</strong>.</p>
<p>NAP uses pending pod resource requirements to decide the optimal virtual machine configuration to run workloads in the most efficient and cost-effective manner. It automatically manages the entire Karpenter lifecycle as a managed AKS addon.</p>
<h3 id="benefits-of-nap">Benefits of NAP</h3>
<ul>
<li><strong>Fully managed</strong>: Microsoft manages the Karpenter deployment, updates, and lifecycle</li>
<li><strong>Zero operational overhead</strong>: No need to install, configure, or maintain Karpenter</li>
<li><strong>Automatic updates</strong>: Karpenter is automatically updated with AKS cluster updates and images</li>
<li><strong>Enterprise support</strong>: Covered under Azure support agreements</li>
<li><strong>Integrated monitoring</strong>: Built-in integration with Azure Monitor, grafana, metrics, and logging</li>
<li><strong>Security</strong>: We manage the bootstrapping token for you</li>
<li><strong>Cost optimization</strong>: Automatically provisions optimal VM configurations for workloads</li>
</ul>
<h3 id="when-to-use-nap">When to Use NAP</h3>
<p>Choose NAP when:</p>
<ul>
<li>You want a production-ready solution with minimal operational overhead</li>
<li>You prefer managed services over self-managed deployments</li>
<li>You need enterprise support and SLA coverage</li>
<li>You want automatic updates and security patches</li>
<li>You don&rsquo;t need deep customization of Karpenter configuration</li>
<li>You want to optimize costs automatically</li>
</ul>
<h3 id="nap--self-hosted-limitations">NAP + Self-Hosted Limitations</h3>
<p><strong>Networking Requirements:</strong>
The recommended network configurations for NAP are:</p>
<ul>
<li>Azure CNI Overlay with Powered by Cilium (recommended)</li>
<li>Azure CNI Overlay</li>
<li>Azure CNI with Powered by Cilium</li>
<li>Azure CNI</li>
</ul>
<p><strong>Unsupported features:</strong></p>
<ul>
<li>Windows node pools</li>
<li>Custom kubelet configuration</li>
<li>IPv6 clusters</li>
<li>Service Principals (use managed identity instead)</li>
<li>Disk encryption sets</li>
<li>CustomCATrustCertificates</li>
<li>Start/Stop mode</li>
<li>HTTP proxy</li>
<li>OutboundType mutation after creation</li>
<li>Private cluster with custom private DNS</li>
<li>Calico network policy</li>
<li>Dynamic IP Allocation</li>
<li>Static Allocation of CIDR blocks</li>
</ul>
<h3 id="using-nap">Using NAP</h3>
<h4 id="create-a-new-cluster-with-nap">Create a new cluster with NAP</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Set environment variables</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">CLUSTER_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>myCluster
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">RESOURCE_GROUP_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>myResourceGroup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Create cluster with NAP enabled</span>
</span></span><span style="display:flex;"><span>az aks create <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --name <span style="color:#000">$CLUSTER_NAME</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --resource-group <span style="color:#000">$RESOURCE_GROUP_NAME</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --node-provisioning-mode Auto <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --network-plugin azure <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --network-plugin-mode overlay <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --network-dataplane cilium <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --generate-ssh-keys
</span></span></code></pre></div><h4 id="enable-nap-on-existing-cluster">Enable NAP on existing cluster</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Enable NAP on existing cluster</span>
</span></span><span style="display:flex;"><span>az aks update <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --name <span style="color:#000">$CLUSTER_NAME</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --resource-group <span style="color:#000">$RESOURCE_GROUP_NAME</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --node-provisioning-mode Auto <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --network-plugin azure <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --network-plugin-mode overlay <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --network-dataplane cilium
</span></span></code></pre></div><h4 id="arm-template-example">ARM Template Example</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;$schema&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;contentVersion&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;1.0.0.0&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;resources&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Microsoft.ContainerService/managedClusters&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;apiVersion&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;2023-09-02-preview&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;napcluster&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;location&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;westus2&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;identity&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;SystemAssigned&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;properties&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;networkProfile&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&#34;networkPlugin&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;azure&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&#34;networkPluginMode&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;overlay&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&#34;networkPolicy&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;cilium&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&#34;networkDataplane&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;cilium&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&#34;loadBalancerSku&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Standard&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;dnsPrefix&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;napcluster&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;agentPoolProfiles&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;agentpool&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;count&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;vmSize&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;standard_d2s_v3&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;osType&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Linux&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;mode&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;System&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;nodeProvisioningProfile&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&#34;mode&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Auto&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="self-hosted-mode">Self-hosted Mode</h2>
<h3 id="what-is-self-hosted-mode">What is Self-hosted Mode?</h3>
<p>Self-hosted mode runs Karpenter as a regular Kubernetes deployment in your cluster, giving you full control over its configuration and lifecycle. You probably don&rsquo;t want this, as that comes with managing the bootstrap token and other headaches. It is our belief that you should use NAP and only use self hosted for experimentation with new feature flags or development of karpenter.</p>
<p>This will change in the future as we add more stability and parity to the two projects.</p>
<h3 id="self-hosted-limitations">Self-hosted Limitations</h3>
<ul>
<li><strong>Operational overhead</strong>: You manage installation, updates, and maintenance</li>
<li><strong>Support responsibility</strong>: You&rsquo;re responsible for troubleshooting and support</li>
<li><strong>Security management</strong>: You must configure identity, RBAC, and security settings</li>
<li><strong>Update management</strong>: Manual process to update Karpenter versions</li>
</ul>
<h3 id="self-hosted-architecture">Self-hosted Architecture</h3>
<p>In self-hosted mode:</p>
<p>In self-hosted mode, Karpenter is deployed directly into your AKS cluster as a standard Kubernetes deployment—typically in the <code>kube-system</code> or a dedicated namespace. This means Karpenter runs alongside your workloads and other cluster components, giving you direct access to its configuration, logs, and lifecycle management.</p>
<p>By contrast, in Node Auto Provisioning (NAP) mode, Karpenter runs as a managed addon within the AKS control plane, alongside the Kubernetes API server and other critical system components. In this managed scenario, you do not interact directly with the Karpenter deployment; Microsoft manages its lifecycle, configuration, and upgrades for you.</p>
<p><strong>Key architectural difference:</strong></p>
<ul>
<li><strong>Self-hosted:</strong> Karpenter runs in your overlay (user) cluster, managed by you.</li>
<li><strong>NAP:</strong> Karpenter runs in the managed AKS control plane, managed by Azure.</li>
</ul>
<p>This distinction affects how you interact with Karpenter, what you can customize, and who is responsible for its operation and security.</p>
<h3 id="installing-self-hosted-karpenter">Installing Self-hosted Karpenter</h3>
<p>See an installation guide <a href="https://github.com/Azure/karpenter-provider-azure?tab=readme-ov-file#installation-self-hosted">here</a>.</p>
<h3 id="features-available-in-nap-but-not-self-hosted">Features Available in NAP but Not Self-hosted</h3>
<p>NAP mode provides several features and capabilities that are not available in self-hosted mode:</p>
<ul>
<li><strong>v6 SKUs</strong>: Only supported in NAP mode. Self-hosted mode does not support v6 generation VM SKUs.</li>
<li><strong>&ndash;dns-service-ip</strong>: Only supported in NAP mode for now.</li>
<li><strong>Automatic bootstrap token management</strong>: NAP handles node bootstrapping tokens automatically, if you are using self-hosted,
you will be managing that token yourself after each upgrade to the systempool or change.</li>
<li><strong>Service CIDR</strong>: Only supported or honored in NAP</li>
<li><strong>Integrated monitoring</strong>: Built-in Azure Monitor integration with predefined metrics and dashboards</li>
<li><strong>Automatic security updates</strong>: Security patches and updates are managed by Azure</li>
<li><strong>Enterprise support</strong>: Covered under Azure support SLAs and agreements feel free to file a support ticket</li>
</ul>
<p><strong>Advanced Capabilities:</strong></p>
<ul>
<li><strong>Optimized provisioning</strong>: NAP uses Azure-specific optimizations for faster node provisioning</li>
<li><strong>Regional feature rollouts</strong>: New Azure features are often available in NAP before self-hosted</li>
<li><strong>Cross-region failover</strong>: Built-in support for multi-region deployments</li>
</ul>
<h2 id="comparison-matrix">Comparison Matrix</h2>
<table>
  <thead>
      <tr>
          <th>Feature</th>
          <th>NAP Mode</th>
          <th>Self-hosted Mode</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>Management</strong></td>
          <td>Fully managed by Microsoft</td>
          <td>User managed</td>
      </tr>
      <tr>
          <td><strong>Installation</strong></td>
          <td>Single CLI command</td>
          <td>Multi-step setup process</td>
      </tr>
      <tr>
          <td><strong>Updates</strong></td>
          <td>Automatic</td>
          <td>Manual</td>
      </tr>
      <tr>
          <td><strong>Support</strong></td>
          <td>Azure enterprise support</td>
          <td>Community + self-support</td>
      </tr>
      <tr>
          <td><strong>Latest features</strong></td>
          <td>Follows AKS release cycle</td>
          <td>Immediate access</td>
      </tr>
      <tr>
          <td><strong>Operational overhead</strong></td>
          <td>Minimal</td>
          <td>High</td>
      </tr>
      <tr>
          <td><strong>Production readiness</strong></td>
          <td>Enterprise ready</td>
          <td>Use at your own risk</td>
      </tr>
      <tr>
          <td><strong>Cost</strong></td>
          <td>Included in AKS</td>
          <td>Self-managed infrastructure</td>
      </tr>
  </tbody>
</table>
<p>With self-hosted karpenter, you will be responsible for managing the node bootstrapping token, which is a very expensive and dangerous thing to manage yourself.</p>
<h2 id="migration-between-modes">Migration Between Modes</h2>
<h3 id="from-self-hosted-to-nap">From Self-hosted to NAP</h3>
<ol>
<li><strong>Backup current configuration</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get nodepools,aksnodeclasses -o yaml &gt; karpenter-backup.yaml
</span></span></code></pre></div><ol start="2">
<li><strong>Uninstall self-hosted Karpenter</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm uninstall karpenter -n kube-system
</span></span></code></pre></div><p>Delete those CRDs + CRs, note you will need to scale down everything for the migration</p>
<ol start="3">
<li><strong>Enable NAP</strong>:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>az aks update --resource-group myRG --name myCluster --node-provisioning-mode Auto
</span></span></code></pre></div><ol start="4">
<li><strong>Recreate NodePools</strong> (configuration may need adjustment for NAP compatibility)</li>
</ol>
<h3 id="from-nap-to-self-hosted">From NAP to Self-hosted</h3>
<p>This configuration is currently untested and unsupported, not to say its impossible just not throughly thought through</p>

	
	
	
</div>


          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
          
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
          
            
  <ul class="list-inline mb-0">
    
      <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
        <a class="text-white" target="_blank" rel="noopener" href="https://github.com/Azure/karpenter-provider-azure" aria-label="GitHub">
          <i class="fab fa-github"></i>
        </a>
      </li>
    
      <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
        <a class="text-white" target="_blank" rel="noopener" href="https://slack.k8s.io/" aria-label="Slack">
          <i class="fab fa-slack"></i>
        </a>
      </li>
    
  </ul>

          
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2025 Microsoft Corporation or its affiliates. All Rights Reserved</small>
        
        
      </div>
    </div>
  </div>
</footer>


    </div>
    
  <script src="/js/main.js"></script>
<script src='/js/prism.js'></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>